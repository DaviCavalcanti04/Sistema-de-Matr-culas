<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<title>Novo Aluno</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
		<div class="container">
			<a class="navbar-brand" href="#">Escola Técnica</a>
			<div class="collapse navbar-collapse">
				<ul class="navbar-nav me-auto">
					<li class="nav-item"><a class="nav-link" href="/alunos/lista">Alunos</a></li>
					<li class="nav-item"><a class="nav-link" href="/cursos/lista">Cursos</a></li>
					<li class="nav-item"><a class="nav-link" href="/componentes/lista">Componentes</a></li>
					<li class="nav-item"><a class="nav-link" href="/turmas/lista">Turmas</a></li>
					<li class="nav-item"><a class="nav-link" href="/matriculas/lista">Matrículas</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">
		<h2>Cadastro de Aluno</h2>

		<!-- Alertas -->
		<div th:if="${erro}" class="alert alert-danger" th:text="${erro}"></div>
		<div th:if="${sucesso}" class="alert alert-success" th:text="${sucesso}"></div>

		<form id="novoAluno" th:action="@{/alunos/salvar}" th:object="${alunoModel}" method="post" class="row g-3" novalidate>
			<div class="col-md-6">
				<label for="nomeAluno" class="form-label">Nome Completo *</label>
				<input type="text" th:field="*{nomeAluno}" class="form-control" id="nomeAluno" required
					oninvalid="this.setCustomValidity('Campo obrigatório')" oninput="this.setCustomValidity('')">
			</div>
			<div class="col-md-6">
				<label for="cpf" class="form-label">CPF *</label>
				<input type="text" th:field="*{cpf}" class="form-control" id="cpf" required
					oninvalid="this.setCustomValidity('Campo obrigatório')" oninput="this.setCustomValidity('')">
			</div>

			<div class="col-md-6">
				<label for="nascimento" class="form-label">Data de Nascimento *</label>
				<input type="date" th:field="*{nascimento}" class="form-control" id="nascimento" required
					oninvalid="this.setCustomValidity('Campo obrigatório')" oninput="this.setCustomValidity('')">
			</div>
			<div class="col-md-6">
				<label for="email" class="form-label">E-mail</label>
				<input type="email" th:field="*{email}" class="form-control" id="email"
					oninvalid="this.setCustomValidity('Campo obrigatório')" oninput="this.setCustomValidity('')">
			</div>
			<div class="col-md-6">
				<label for="telefone" class="form-label">Telefone *</label>
				<input type="text" th:field="*{telefone}" class="form-control" id="telefone" required
					oninvalid="this.setCustomValidity('Campo obrigatório')" oninput="this.setCustomValidity('')">
			</div>

			<div class="col-12">
				<button type="submit" class="btn btn-success">Salvar</button>
				<a href="/alunos/lista" class="btn btn-secondary">Voltar</a>
			</div>
		</form>
	</div>
	<script>
		const f = id => document.getElementById(id),
			req = ["nomeAluno", "nascimento", "telefone", "cpf"];


		f("cpf").oninput = e => {
			let v = e.target.value.replace(/\D/g, "").slice(0, 11);
			e.target.value = v.replace(/(\d{3})(\d)/, "$1.$2")
				.replace(/(\d{3})(\d)/, "$1.$2")
				.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
		};
		f("telefone").oninput = e => {
			let v = e.target.value.replace(/\D/g, "").slice(0, 11);
			v = v.length <= 10
				? v.replace(/(\d{2})(\d{4})(\d+)/, "($1)$2-$3")
				: v.replace(/(\d{2})(\d{5})(\d+)/, "($1)$2-$3");
			e.target.value = v;
		};

		function menor13() {
			const n = new Date(f("nascimento").value), h = new Date();
			let i = h.getFullYear() - n.getFullYear();
			if (h < new Date(n.setFullYear(n.getFullYear() + i))) i--;
			return i < 13;
		}
		f("nascimento").onchange = () =>
			f("erroIdade").classList.toggle("d-none", !menor13());

		function emailValido(e) {
			return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
		}

		f("novoAluno").onsubmit = e => {

			for (let id of req) {
				f(id).setCustomValidity('');
			}

			if (menor13()) {
				alert("Idade mínima é 13 anos.");
				e.preventDefault();
				return;
			}

			for (let id of req) {
				if (!f(id).value.trim()) {
					f(id).setCustomValidity("Campo obrigatório");
					f(id).reportValidity();
					e.preventDefault();
					return;
				}
			}

			if (f("email").value && !emailValido(f("email").value)) {
				alert("E-mail inválido.");
				e.preventDefault();
			}
		};
	</script>

</body>

</html>